# Balancer project
Balancer project - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Ö –ø–æ –ø—É–ª—É –±—ç–∫–µ–Ω–¥-—Å–µ—Ä–≤–µ—Ä–æ–≤.

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)
- [–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã](#–Ω–∞—á–∞–ª–æ-—Ä–∞–±–æ—Ç—ã)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
- [API](#api)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [To do](#to-do)

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
### –û—Å–Ω–æ–≤–Ω—ã–µ
- [Go:v1.23.2](https://github.com/golang/go)
- [PostgreSQL:v17.4](https://github.com/postgres/postgres)
- [Docker:v28.0.4](https://github.com/docker)
- [Docker compose:v2.34.0](https://github.com/docker/compose)

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
- [PGX:v5.7.4(db driver)](https://github.com/jackc/pgx)
- [Goose:v3.24.2(migrations)](https://github.com/pressly/goose)
- [Squirrel:v1.5.4(query builder)](https://github.com/Masterminds/squirrel)

---

## –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã

**–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã —Å–≤–µ—Ä—å—Ç–µ—Å—å —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π.**
**–¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤, .env –∏ make —Ñ–∞–π–ª–∞, –∞ —Ç–∞–∫–∂–µ —Ñ–∞–π–ª—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏**

### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ —Å –ø–æ–º–æ—â—å—é docker
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ docker –Ω–∞ —Å–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:
[–ì–∞–π–¥ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ](https://docs.docker.com/engine/install/)

**–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã**
```sh
docker pull postgres:17.4
```
```sh
docker pull s3m23/balancer:v0.1
```
```sh
docker pull s3m23/backend-test:v0.1
```

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```sh
make fullsetup-up
```

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ goose –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```sh
make install-goose
```
```sh
make migration-up
```


–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
```sh
make fullsetup-down
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (—è —Å—Ç–∞—Ä–∞–ª—Å—è üòÖ)

```cmd``` - –∫–æ—Ä–µ–Ω—å –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–∞, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, —Å–µ—Ä–≤–∏—Å–æ–≤, api, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç—É—Ç

```internal/api/handler``` - —Å–ª–æ–π –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥—è—Ç—Å—è HTTP endpoit'—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–æ–µ–∫—Ç–æ–º

```internal/config``` - –ø–∞—Ä—Å–∏–Ω–≥ –∏ –ª–æ–≥–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞

```internal/model``` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–æ–µ–∫—Ç–æ–º –∏ –¥–ª—è –µ–≥–æ —Ä–∞–±–æ—Ç—ã

```internal/repository``` - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

```internal/service``` - –±–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

–°—Ç–æ–∏—Ç –ø—Ä–æ–π—Ç–∏—Å—å –ø–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º:

```internal/service/in-memory-cache``` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–µ—à–∞ –∏ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –Ω–∏–º

```internal/service/interfaces``` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```internal/service/limits-manager``` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º rate –ª–∏–º–∏—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤

```internal/service/pool-service``` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è pool'–∞ –±—ç–∫–µ–Ω–¥–æ–≤, health checks, –∞ —Ç–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥—ã

```internal/service/token-manager``` - –º–æ–¥—É–ª—å –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (rate-limiting) –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ Token Bucket

---

## API

API –ø–æ–¥—Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –¥–≤–∞ —Ç–∏–ø–∞:

**API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ backend-—Å–µ—Ä–≤–µ—Ä—ã —á–µ—Ä–µ–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫**
**API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è rate –ª–∏–º–∏—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

---

### 1. API –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ backend-—Å–µ—Ä–≤–µ—Ä—ã

–≠–Ω–¥–ø–æ–∏–Ω—Ç, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫ backend-—Å–µ—Ä–≤–µ—Ä–∞–º:

- `/` ‚Äî –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–¥–∏–Ω –∏–∑ backend-—Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏

### 2. API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è rate –ª–∏–º–∏—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

| –ú–µ—Ç–æ–¥  | URL                | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                          | –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (JSON)                                                                 | –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (JSON)                                                            | –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ |
|--------|--------------------|-------------------------------------|---------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|------------|
| POST   | `/limits/create`   | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–∏–º–∏—Ç                | ```json<br>{ "client_id": "123.5.6.7:890", "capacity": 10, "rate_per_sec": 1 }```     | ‚Äî                                                                                | `201 Created` |
| GET    | `/limits/get`      | –ü–æ–ª—É—á–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ client_id        | ```json<br>{ "client_id": "123.5.6.7:890" }```                                        | ```json<br>{ "client_id": "123.5.6.7:890", "capacity": 10, "rate_per_sec": 1 }``` | `200 OK` |
| PUT    | `/limits/update`   | –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç                     | ```json<br>{ "client_id": "123.5.6.7:890", "capacity": 10, "rate_per_sec": 1 }```     | ‚Äî                                                                                | `204 NoContent` |
| DELETE | `/limits/delete`   | –£–¥–∞–ª–∏—Ç—å –ª–∏–º–∏—Ç                      | ```json<br>{ "client_id": "123.5.6.7:890" }```                                        | ‚Äî                                                                                | `204 NoContent` |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–æ—Å—Ç–æ–π echo —Å–µ—Ä–≤–µ—Ä ```test-backend```
–û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç json —Ñ–∞–π–ª—ã –∏ –≤—ã–≤–æ–¥–∏—Ç –º–µ—Ç–æ–¥ –∏ uri –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π json
Request:
```sh
{
    "exaple":123
}
```
Reasponse:
```sh
{
    "http_method": "GET",
    "request_uri": "/",
    "your_message": {
        "exaple": 123
    }
}
```
---

## To do
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è least connections
- [ ] –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å LRU cache
